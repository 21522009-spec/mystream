worker_processes  auto;

events {
  worker_connections  1024;
}

rtmp {
  server {
    listen 1935;
    chunk_size 4096;

    # VOD qua RTMP: rtmp://HOST:1936/vod/<file.mp4>
    application vod {
      play /var/vod;
    }

    # Live RTMP publish: rtmp://HOST:1936/live/<streamKey>
    application live {
      live on;

      # Record livestream -> /recordings
      record all;
      record_path /var/recordings;
      record_unique on;
      record_suffix .flv;

      # Tạo HLS trực tiếp
      hls on;
      hls_path /tmp/live/hls;
      hls_fragment 3s;
      hls_playlist_length 60s;

      # Restream (bật khi cần)
      # push rtmp://a.rtmp.youtube.com/live2/YOUR_YOUTUBE_STREAM_KEY;
      # push rtmp://live-api-s.facebook.com:443/rtmp/YOUR_FACEBOOK_STREAM_KEY;
    }
  }
}

http {
  server {
    listen 80;

    # Live HLS: http://HOST:8080/live/hls/<streamKey>.m3u8
    location /live {
      types {
        application/vnd.apple.mpegurl m3u8;
        video/mp2t ts;
      }
      alias /tmp/live;
      add_header Cache-Control no-cache;
      add_header Access-Control-Allow-Origin *;
    }

    # VOD HLS: http://HOST:8080/vod/<videoId>/index.m3u8
    location /vod {
      types {
        application/vnd.apple.mpegurl m3u8;
        video/mp2t ts;
      }
      alias /tmp/hls;
      add_header Cache-Control no-cache;
      add_header Access-Control-Allow-Origin *;
    }

    # Statistics: http://HOST:8080/stat
    location /stat {
      rtmp_stat all;
      rtmp_stat_stylesheet stat.xsl;
    }
    location /stat.xsl {
      root /usr/local/nginx/html;
    }
  }
}
